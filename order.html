<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Order Confirmation</title>

<style>
@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap');

body {
  margin: 0;
  padding: 0;
  font-family: 'Poppins', sans-serif;
  background: linear-gradient(180deg, #2d0f18, #6d2b3a);
  color: #ffd6ea;
  min-height: 100vh;
  display: flex;
  justify-content: center;
  align-items: center;
}

/* Center card */
.confirm-box {
  background: linear-gradient(180deg, rgba(0,0,0,0.45), rgba(0,0,0,0.6));
  padding: 30px;
  width: 90%;
  max-width: 520px;
  border-radius: 18px;
  text-align: center;
  box-shadow: 0 20px 40px rgba(0,0,0,0.55);
  border: 1px solid rgba(255,255,255,0.05);
}

.confirm-box h1 {
  font-size: 30px;
  margin-bottom: 10px;
  color: #ff8abf;
  text-shadow: 0 0 15px rgba(255,90,151,0.4);
}

.confirm-box h3 {
  font-weight: 600;
  color: #ffd6ea;
  margin-bottom: 6px;
}

.confirm-box p {
  font-size: 0.95rem;
  color: #ffd6eacc;
  margin: 5px 0 10px;
}

/* Order list box */
.order-items {
  text-align: left;
  background: rgba(255,255,255,0.03);
  padding: 12px;
  border-radius: 12px;
  margin-top: 12px;
  border: 1px solid rgba(255,255,255,0.05);
}

.order-items .row {
  display:flex;
  justify-content:space-between;
  gap:12px;
  padding:8px 6px;
  border-bottom:1px dashed rgba(255,255,255,0.02);
}
.order-items .row:last-child { border-bottom: none; }

.back-btn {
  margin-top: 18px;
  padding: 10px 18px;
  background: linear-gradient(90deg, #ff8abf, #ff3ca6);
  color: white;
  font-weight: 600;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  transition: 0.3s ease;
}

.back-btn:hover {
  transform: scale(1.05);
}
</style>

</head>
<body>

<div class="confirm-box">
  <h1>ðŸŽ€ Order Confirmed ðŸŽ€</h1>

  <div id="order"></div>

  <button class="back-btn" onclick="window.location.href='index.html'">
    Back to Shop
  </button>
</div>

<!-- EmailJS -->
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@2/dist/email.min.js"></script>

<script>
// --- keep your EmailJS init key (already present) ---
emailjs.init("YwTWDK2zdlv0oqPSj");

// Load order from localStorage
const order = JSON.parse(localStorage.getItem("order") || 'null');

if(!order || !order.cart || order.cart.length === 0){
  // No order found â€” go back to homepage
  document.getElementById('order').innerHTML = '<p style="color:#ffd6ea">No recent order found. Redirecting to shop...</p>';
  setTimeout(()=> window.location.href = 'index.html', 1500);
} else {

  // normalize cart items â€” ensure qty and numeric price
  const cart = order.cart.map(item => {
    return {
      id: item.id || item.name,
      name: item.name,
      price: Number(item.price) || 0,
      qty: Number(item.qty) || 1
    };
  });

  // compute totals
  const linesHtml = cart.map(it => {
    const lineTotal = it.price * it.qty;
    return `<div class="row"><div style="font-weight:600">${it.name} ${it.qty>1? 'Ã—'+it.qty : ''}</div><div>â‚¹${lineTotal}</div></div>`;
  }).join('');

  const total = cart.reduce((s, it) => s + (it.price * it.qty), 0);

  // create a canonical order object to save to user accounts or server
  const orderObj = {
    id: 'ORD_' + Date.now().toString(36),
    name: order.name || '',
    email: order.email || '',
    address: order.address || '',
    phone: order.phone || '',
    items: cart,
    total: total,
    created: new Date().toISOString()
  };

  // show order details in the card
  document.getElementById("order").innerHTML = `
    <h3>Thank you, ${orderObj.name || 'Customer'}!</h3>
    <p>We will ship your order to:</p>
    <p><strong>${orderObj.address}</strong></p>

    <p>Your order:</p>
    <div class="order-items">
      ${linesHtml}
      <div style="padding:8px 6px; text-align:right; font-weight:700; margin-top:8px;">Total: â‚¹${orderObj.total}</div>
    </div>
  `;

  // Attach order to signed in user account (if account system exists)
  try{
    if(window.pp_accounts && typeof window.pp_accounts.attachOrderToUser === 'function'){
      window.pp_accounts.attachOrderToUser(orderObj);
      // optional: notify user
      console.log('Order attached to user account:', orderObj.id);
    } else {
      console.log('No account system found â€” order saved only in local storage.');
    }
  } catch(e){ console.warn('attachOrderToUser failed', e); }

  // Email Notification (EmailJS)
  try{
    emailjs.send("service_npylb3d", "template_2z3qz9a", {
      name: orderObj.name,
      address: orderObj.address,
      email: orderObj.email,
      items: orderObj.items.map(p => `${p.name} x${p.qty}`).join(", "),
      total: orderObj.total,
      order_id: orderObj.id
    }).then(function(){
      console.log('EmailJS: email sent');
    }, function(err){
      console.warn('EmailJS error', err);
    });
  } catch(e){
    console.warn('EmailJS send failed', e);
  }

  // Optional: clear cart & order from localStorage if you want
  // localStorage.removeItem('cart');
  // localStorage.removeItem('order');
}
</script>

</body>
</html>
